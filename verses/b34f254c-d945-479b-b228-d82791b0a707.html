<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - SlackHQ 使用 Kafka 和 Redis 处理数十亿任务</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">SlackHQ 使用 Kafka 和 Redis 处理数十亿任务</h2>
  </header>
  <div class="entry-content">
        <p><a href="https://slack.engineering/scaling-slacks-job-queue-687222e9d100">查看原文</a></p>
<p>本文是 Slack 工程博客关于如何扩展他们的任务队列的分享，他们的任务队列具体来说运行任何不在 web request 中执行的任务，例如推送提醒，unfurl，账单计算等，高峰时期队列 qps 可达到 33k/per second，任务时长从毫秒到数分钟不等。初版设计在公司上古时代就在用了，还用了很多年。Scaling 的契机是遇上了一次生产环境的大故障，就出在这个任务队列系统上，简单来说数据库资源争抢导致任务执行时间变长直到 Redis 内存超限，Boom。恢复时还屋漏偏逢连夜雨的碰上了任务没法 dequeue。所以，事故后，他们的重新设计的目标是：在核心系统最小故障时间的前提下，做到不停机的升级。</p>
<ul>
<li>初版设计：[www1 www2 www3] =&gt; [redis1 redis2 redis3 redis4] =&gt; [worker1 worker2 worker3 worker4], www 可以任意发布任务到 redis，每个 worker 监听一到两个 redis。www 会做任务哈希分配到一个 redis 去，如果必要做一次 job deduplication, 忽略已在队列中的任务。worker 把任务从 pending queue 中挪走创建出异步任务执行之，执行成功就弹走任务，否则重试直到失败挪到failure queue去。听上去吧，就是非常常规的万金油式的队列设计。</li>
<li>问题分析：如果 enqueue / dequeue 速率不匹配，就会导致 redis 内存超限，尤其是出在 slack 这样 qps 很高的应用, 一旦失衡一会会儿就崩溃了。worker 要去连很多 redis instance。加新的 worker 会给 redis 加负载，有潜在的拖垮系统的风险。</li>
<li>潜在方案：1) 换成 Kafka，换成 durable storage，防止内存耗尽任务丢失 2) 提供更好地队列支持例如 rate-limiting, prioritization 3) 就干脆不用 Redis 好了。</li>
<li>实际方案：在 Redis 前面加装一层 Kafka，处于时间人力的考量，算是 1) 的折衷: [www1 www2 www3] =&gt; [kafkagate] =&gt; [kafka] ===(relay by topic)===&gt; [redis1] [redis2] [redis3] =&gt; [worker1 worker2 worker3].<ul>
<li>kafkagate 是自撸的 Go HTTP stateless 服务，将任务 enqueue 到 Kafka。处于性能考量，他们 Kafka 选择了 leader ack request 后就认为写入好了，而不是等到任务 replicate 到 brokers 后才认为写好。这引入了丢失任务的风险，但也减少了拖垮系统的风险。这个层也使 job 优先路由到当前 AZ，且 failover 时路由到其它 AZ 变得简单。</li>
<li>relay 这层还是 Go service，使用的是叫做 JQRelay 的工具。关注的核心问题是 data encoding（很不巧地还碰上了 PHP/GO 的 JSON encoder 实现不一样）。Relay 还要考虑一点就是起实例的时候要获取一个 Consul 锁，锁住 Topic 的读。这个锁保证了实例死掉的时候其它实例可以快速接管任务。</li>
<li>kafka 有 16 个 brokers 运行在 i3.2xlarge EC2 instances (财大气粗？)，每个 topic 32 partitions，replication factor=3，暂存两天。同时做压测，故障测试。</li>
</ul>
</li>
<li>上线：往两个系统写，新系统行为正确后，花几周时间慢慢切到新系统。</li>
</ul>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>
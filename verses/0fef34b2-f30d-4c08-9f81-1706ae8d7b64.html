<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - Protothreads - lightweight stackless threads</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">Protothreads - lightweight stackless threads</h2>
  </header>
  <div class="entry-content">
        <p><a href="http://dunkels.com/adam/pt/">查看原文</a></p>
<p>本文介绍了 Protothread 这种无栈线程的小众实现，由于不需要线程或者多进程就能实现多任务协程，它被用于 Arduino / 感应器这种嵌入式设备中。每个 PT 仅占用两个 bytes 大小，理论上你可以创建比 Actor 模型还多两个数量级的并发任务出来。由于仅仅是几个 C 的宏，它极具迁移性，甚至可以在无 OS 的环境运行。它的核心实现就下面几行代码：</p>
<div class="highlight"><pre><span></span><code><span class="err">struct pt { unsigned short lc; };</span>
<span class="err">#define PT_THREAD(name_args)  char name_args</span>
<span class="err">#define PT_BEGIN(pt)          switch(pt-&gt;lc) { case 0:</span>
<span class="err">#define PT_WAIT_UNTIL(pt, c)  pt-&gt;lc = __LINE__; case __LINE__: \</span>
<span class="err">                              if(!(c)) return 0</span>
<span class="err">#define PT_END(pt)            } pt-&gt;lc = 0; return 2</span>
<span class="err">#define PT_INIT(pt)           pt-&gt;lc = 0</span>
</code></pre></div>


<p>以下代码</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span>
<span class="n">PT_THREAD</span><span class="p">(</span><span class="n">example</span><span class="p">(</span><span class="n">struct</span> <span class="n">pt</span> <span class="o">*</span><span class="n">pt</span><span class="p">))</span>
<span class="err">{</span>
  <span class="n">PT_BEGIN</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>

  <span class="n">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="err">{</span>
    <span class="n">PT_WAIT_UNTIL</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span>
      <span class="n">counter</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="ss">&quot;Threshold reached\n&quot;</span><span class="p">);</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="err">}</span>

  <span class="n">PT_END</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
<span class="err">}</span>
</code></pre></div>


<p>扩展后可变为 </p>
<div class="highlight"><pre><span></span><code><span class="k">static</span>
<span class="nb">char</span> <span class="n">example</span><span class="p">(</span><span class="n">struct</span> <span class="n">pt</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span>
<span class="err">{</span>
  <span class="n">switch</span><span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">lc</span><span class="p">)</span> <span class="err">{</span> <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>

  <span class="n">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="err">{</span>
    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span> <span class="k">case</span> <span class="mi">12</span><span class="p">:</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">counter</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="ss">&quot;Threshold reached\n&quot;</span><span class="p">);</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="err">}</span>

  <span class="err">}</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">lc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>


<p>其中 <code>pt-&gt;lc = 12; case 12:</code> 这行代码非常鬼畜，它包含在了 while(1) 里面，但是确实可以这么使用。</p>
<p>下面是 我用 <a href="https://github.com/zserge/pt">zserge/pt</a> 的 PT 版本实现的 ping-pong 模型（在 Erlang 里面常当作教程的例子）：</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;pt.h&quot;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="nf">pt_queue</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">byte_queue_t</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">ping</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">mail</span><span class="p">;</span>
    <span class="n">pt_begin</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">pt_wait</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="o">*</span><span class="n">ok</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;ping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="o">*</span><span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pt_end</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">pong</span><span class="p">(</span><span class="k">struct</span> <span class="n">pt</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">mail</span><span class="p">;</span>
    <span class="n">pt_begin</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">pt_wait</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="o">!*</span><span class="n">ok</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pong</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="o">*</span><span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">pt_end</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">pt</span> <span class="n">ping_pt</span> <span class="o">=</span> <span class="n">pt_init</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">pt</span> <span class="n">pong_pt</span> <span class="o">=</span> <span class="n">pt_init</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">ping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ping_pt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
        <span class="n">pong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pong_pt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>从原理上讲，Protothread 其实就是一个轻量的协程库，函数内部需要自己主动写一个切出控制权的语句（pt_wait），而这个语句唯一在意要存储的变量就是下次跳进来还从这里运行，所以这个通过行号 <code>__LINE__</code> 实现的数字就成了整个 struct pt 唯一需要放进内存的值。</p>
<p>衍生思考：探究语言的边际 Case 可以催生很好玩的的使用场景。合理编排而又有美感的 API 让人可以忘却底层恶心的实现。</p>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>
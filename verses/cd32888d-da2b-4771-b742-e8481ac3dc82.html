<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - Prometheus 监控最佳实践</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">Prometheus 监控最佳实践</h2>
  </header>
  <div class="entry-content">
        <p><a href="https://prometheus.io/docs/practices/instrumentation/">查看原文</a></p>
<p>本文是 Prometheus 的一份文档，提供了一系列侵入代码做监控时的建议。</p>
<ul>
<li>监控任何东西，能想到的。一个程序中的每个部分都至少有一些指标可以让我们看到它们工作地肿么样。</li>
<li>侵入代码的监控就跟日志一样，可以做到就在代码那个文件做初始化。</li>
<li>一般监控的东西可以是：<ul>
<li>在线服务: 推荐采集的指标：qps/qpm, errors, latency. 如果有客户端可以在 c/s 两端都采集。</li>
<li>离线服务: 推荐采集的指标：in_progress_num, processed_num, last_processed_time. 如果系统不是一直都在工作，建议发心跳工作包给服务，服务简单处理下时间啊什么的，确保它是一直是响应着的。</li>
<li>Batch Job：它可能只是一次性的任务。推荐使用 pushgateway 推数据给 prometheus。采集的指标可以是：运行了多久，每一步花了多久，什么时候结束，成功还是失败。如果这个 batch job 以固定频率运行，建议转成 offline-processing。</li>
<li>Library: 推荐采集的指标(可以做采样)：qps/qpm, errors, latency, network, disk, ...</li>
<li>Logging: 规则：每行日志最好都有特定的 counter 与之对应。或者简单地将  info/error/warning 做个加总，这样也很好查看程序的行为。</li>
<li>Failure： 规则：每次失败都有特定的 counter 与之对应。</li>
<li>Threadpools： 推荐采集的指标：queued_requests_num, inuse_thread_num, total_thread_num. processed_tasks_num, duration, queue_waiting_milliseconds.</li>
<li>Caches: total queries, hits, overall latency and then the query count, errors and latency</li>
</ul>
</li>
<li>其它建议<ul>
<li>尽量使用标签</li>
<li>但不要过度使用标签（控制在10个以内</li>
<li>大小只往上跑的数据可以用 counter，能上能下的用 gauge</li>
<li>可以把事件发生的时间也暴露为一个指标。</li>
<li>宁愿给出 fallback 的指标，也不要丢了。</li>
</ul>
</li>
</ul>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>
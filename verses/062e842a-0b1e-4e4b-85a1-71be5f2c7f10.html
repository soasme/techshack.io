<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - Redis 数据持久化</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">Redis 数据持久化</h2>
  </header>
  <div class="entry-content">
        <p><a href="https://redis.io/topics/persistence">查看原文</a></p>
<p>本文是 Redis Persistence 的 tech spec，是一篇每个 Redis 用户都建议读的文章。</p>
<ul>
<li>RDB 是定时存储快照</li>
<li>AOF 是增量添加写操作的日志（append-only fashion）</li>
<li>两个都是可选关掉的，或者同时打开。AOF 优先用于重启时的数据恢复</li>
</ul>
<p>比较：</p>
<ul>
<li>RDB<ul>
<li>单文件，压缩好，适合备份做灾难恢复，恢复速度快，备份进程不影响提供服务的父进程的性能。</li>
<li>可能会丢数据（总不能每秒都 dump 吧？一般隔几个分钟小时的），备份时 fork 会可能卡住父进程一会会儿。</li>
<li>基本流程：Redis fork, 子进程把数据全量写到 rdb 文件，写完后替换老的 rdb 文件。</li>
</ul>
</li>
<li>AOF<ul>
<li>优点：性能好！能在日志太大时自动 rewrite, 也不会影响现有的插入 </li>
<li>缺点：日志数据可能会坏掉，比如因为断电一行日志没写完，可以通过 redis-check-aof 简单修复。</li>
<li>缺点: 日志大，速度慢，可能恢复出来的数据会不一样（bug，但可能发生）</li>
<li>性能：根据不同 fsync 可以调整对父进程的性能影响, fsync 每次写性能差但数据更安全，隔几秒刷一次性能好一些，从不 fsync 让操作系统来管的话就更不安全然而快的飞起。一般来说每秒 fsync 足够安全。</li>
<li>数据修复： 备份 aof 文件，运行 redis-check-aof --fix，重启 Redis。可以通过 diff 来看中间什么数据丢了。</li>
<li>Log rewriting 基本流程: fork, 子进程开写新的 AOF 文件，Redis 在内存中暂存数据，写完后把新的写操作应用到 AOF 文件去，最后替换老的 aof 文件。</li>
</ul>
</li>
</ul>
<p>使用：</p>
<ul>
<li>如果很关心数据安全，二者都开</li>
<li>如果丢几分钟数据不打紧，开 RDB</li>
<li>单开 AOF 不推荐，有个 RDB 在你为什么不用！</li>
</ul>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>
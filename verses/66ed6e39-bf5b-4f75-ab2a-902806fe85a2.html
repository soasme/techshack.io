<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - 实战：Facebook 直播如何应对流量高峰</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">实战：Facebook 直播如何应对流量高峰</h2>
  </header>
  <div class="entry-content">
        <p><a href="https://code.facebook.com/posts/166966743929963/how-production-engineers-support-global-events-on-facebook/">查看原文</a></p>
<p>视频直播服务很容易收到特殊事件的冲击导致出现流量高峰。对于 Facebook Live 服务，他们的系统有三种常见的模式：Routine（作息导致的高峰和低谷），完全无法预测的高峰（例如自然灾害或者灾难或者哪里枪击案了），预期的高峰（例如节日）。要让系统很好地应对流量高峰，首先需要对系统架构有认知，找出瓶颈，然后逐个测试其上限，平时做演练，最后真刀真枪时上备好的服务器增强容量。</p>
<p>对于 Facebook Live，他们的架构分三层，直播的客户端的 RTMPS TCP 流数据通过 Edge PoP 到达 Facebook Live Servers (FBLS), 完成 HD/SD encoding 以后永久存储到 Distributed Media Storage，同时数据会通过 Facebook CDN 到达 回放的客户端。</p>
<p>这个系统架构的主要资源消耗在这几个组件中：</p>
<ul>
<li>Edge PoP</li>
<li>Facebook Live Servers (FBLS)</li>
<li>Distributed Media Storage</li>
<li>FB CDN</li>
</ul>
<p>同时，一些基础服务，例如 log storage, metrics collection, configuration distribution 都有可能受到影响。说到 metrics，他们使用了三种指标，分别是每天直播的总量，一天的峰值，以及 scaling 对其它系统造成的负载。其中峰值是最主要的指标，特别是用于预备 capacity 的时候。最后的指标也很重要，主要体现在 routing host 和 app server 中间会有 many-to-many 的连接，当 scale 上去以后，健康检查会产生更多的网络流量，相应地，要调低健康检查的间隔。</p>
<p>应对突发流量的操作倒是简单：备好服务器，不够了就补上去。同时照顾好监控的指标，相应的调整一些参数，除了上限提到的健康检查间隔，还有视频存储的最小单元调长，以减少 IO 写次数。</p>
<p>预演是应对突发流量所必须的。在没出现流量高峰的时候就做 Load Testing，确保系统来流量的时候扛得住。造流量的方法可以是：</p>
<ul>
<li>把流量调到一部分服务器去</li>
<li>对存储系统做 Synthetic load test，简单写入大容量的合成数据。</li>
<li>或者把生产环境的流量 replicate，导到独立的环境里面去测试。当然，要确保这些流量不会和线上的混起来。</li>
</ul>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>
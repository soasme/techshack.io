<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - Python CFFI Overview</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">Python CFFI Overview</h2>
  </header>
  <div class="entry-content">
        <p><a href="https://cffi.readthedocs.io/en/latest/overview.html">查看原文</a></p>
<p>CFFI 是 Python 和 C 交互的一个库，它有 ABI x in-line, ABI x out-of-line, API x in-line, API x out-of-line 四种接口。</p>
<p>ABI 驳接的是已经编译好的 binary，API 更快，把 C 代码编译出来使用。 in-line 是在 Python 中每次使用都要 setup，out-of-line 则需要提前生成好模块，然后在主程序中调用。</p>
<p>ABI x inline:</p>
<div class="highlight"><pre><span></span><code><span class="err">ffi = FFI()</span>
<span class="err">ffi.cdef(&quot;&quot;&quot;C SOURCE HERE&quot;&quot;&quot;)</span>
<span class="err">C = ffi.dlopen(None)</span>
<span class="err">C.printf(&quot;…&quot;)</span>
</code></pre></div>


<p>API, out-of-line</p>
<p>编译</p>
<div class="highlight"><pre><span></span><code><span class="err">ffi = FFI()</span>
<span class="err">ffi.set_source(&quot;my_module&quot;, &quot;&quot;&quot;C SOURCE HERE&quot;&quot;&quot;)</span>
<span class="err">ffi.cdef(&quot;&quot;&quot;DECLAREATIONS&quot;&quot;&quot;)</span>
<span class="err">if __name__ == &#39;__main__&#39;:</span>
<span class="err">    ffi.compile()</span>
</code></pre></div>


<p>使用前需要运行脚本, 生成 my_module.c 源码然后编译成 my_module.so / my_module.pyd。可以向普通 Python 模块一样调用：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">my_module</span> <span class="kn">import</span> <span class="n">lib</span>
<span class="n">lib</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</code></pre></div>


<p>ABI, out-of-line</p>
<div class="highlight"><pre><span></span><code><span class="err">ffi = FFI()</span>
<span class="err">ffi.set_source(&quot;my_module&quot;, None)</span>
<span class="err">ffi.cdef(&quot;&quot;&quot;C SOURCE HERE&quot;&quot;&quot;)</span>
<span class="err">if __name__ == &#39;__main__&#39;:</span>
<span class="err">    ffi.compile()</span>
</code></pre></div>


<p>也要运行它生成 my_module.py。使用：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">my_module</span> <span class="kn">import</span> <span class="n">ffi</span>
<span class="n">lib</span> <span class="o">=</span> <span class="n">ffi</span><span class="o">.</span><span class="n">dlopen</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
<span class="n">lib</span><span class="o">.</span><span class="k">print</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
</code></pre></div>


<p>一些限制：</p>
<ul>
<li>cdef 只能支持 types, functions, constants, global variables, 不支持 #ifdef 这些宏。</li>
<li>API in-line 现在已经废弃了。</li>
</ul>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>
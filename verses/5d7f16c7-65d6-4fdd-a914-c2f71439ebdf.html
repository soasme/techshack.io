<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - 协议阅读 - ASGI</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">协议阅读 - ASGI</h2>
  </header>
  <div class="entry-content">
        <p><a href="https://github.com/django/asgiref/blob/master/specs/asgi.rst">查看原文</a></p>
<p>ASGI 全称是 Asynchronous Server Gateway Interface，它旨在为 Python 网络服务器程序提供一套标准接口。它规定了一套服务器交互和运行 app 程序的 API。</p>
<p>它的前身是 WSGI，WSGI 只关注 HTTP 的请求响应模型，另外 WebSocket 也不包括在里面。ASGI 有着更大的野心。</p>
<p>ASGI 有两个组件：Protocol Server &amp; Application。前者处理 sockets，转为 pre-event messages；后者存活在 protocol server, per socket 中，处理 event messages。app 不像 WSGI 那样是个 callable，而是一个 instantiated object。 ASGI connection 也有两部分：connection scope, 和 Events。前者在连接建立期间一直存在，后者则是在连接中有特定事件发生时发送至 app。</p>
<ul>
<li>用户建立连接 = app instance created.</li>
<li>直到用户断开链接期间 = connection scope.</li>
<li>connection scope 会送进来的信息，依赖于协议是怎么规定的。</li>
<li>app 在进入 初始化，提供了 connection scope 后才能与 client 通信，有的协议中可能还需要等待初始事件。</li>
<li>http 事件就俩：<code>http.request</code> 和 <code>http.disconnect</code></li>
<li>websocket 事件多一些：<code>websocket.connect</code>, <code>websocket.receive</code>, <code>websocket.receive</code>, <code>websocket.disconnect</code>.</li>
<li>消息就是一个 dict，其中至少有个 type 字段。用户可自定义 消息的 type。</li>
<li>消息类型限定在byte, unicode, int, float, list, dict, bool, none。JSON 无法区分 byte 和 unicode, 可以将 byte string 转为 base64, 用 U+FFFF 打头。</li>
<li><code>application(scope)</code>. scope 也是一个含 type 的 dict， 返回 <code>co app_instance(receive, send)</code>, 其中 receive 是一个等待直到新事件可用的 awaitable, send 是发送完成后会 return 的 awaitable. 简单来说，可以写成下面的样子：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="n">Application:</span>

    <span class="n">def</span> <span class="n">__init__</span>(<span class="nb">self</span>, <span class="nb">scope</span>):
        ...

    <span class="n">async</span> <span class="n">def</span> <span class="n">__call__</span>(<span class="nb">self</span>, <span class="nb">receive</span>, <span class="nb">send</span>):
        ...
</code></pre></div>


<ul>
<li>low-level 的信息可由 server 处理，无需转为 asgi events. datagram-based protocol 中报文 = 消息，除非 size 成问题。</li>
</ul>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>
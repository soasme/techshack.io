<!DOCTYPE html>
<html lang="en">
<head>
    <title>Techshack Weekly - AWS CNI Proposal</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://www.soasme.com/techshack.weekly/theme/css/main.css" type="text/css" />
        <link href="https://www.soasme.com/techshack.weekly/" type="application/atom+xml" rel="alternate" title="Techshack Weekly ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie.css"/>
                <script src="https://www.soasme.com/techshack.weekly/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://www.soasme.com/techshack.weekly/css/ie6.css"/><![endif]-->

</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-lg-2"></div>
            <div id="content" class="col-lg-6">
                <div class="entry">
<section id="content" class="body">
  <header>
    <h2 class="entry-title">AWS CNI Proposal</h2>
  </header>
  <div class="entry-content">
        <p><a href="https://github.com/aws/amazon-vpc-cni-k8s/blob/master/docs/cni-proposal.md">查看原文</a></p>
<p>AWS VPS CNI K8S</p>
<p>本文是 aws-cni 的设计文档。AWS Kubernetes CNI 插件可用于在 EKS 中提供类似 Flannel, Calico 这类网络软件的功能 - 为 Pod 配置必要的网络。</p>
<p>更具体的，它的设计目标：
* 为成为 kubernetes 节点的每个 ec2 实例创建多个 Elastic network interface（ENI），分配二级 IP 地址
* 为每个 Pod 挑选一个可用的二级 IP 地址，把主机跟 Pod 的网络连起来，允许 Pod-Pod, Pod-PodInAnotherHost, Pod-AWSService, Pod-DC, Pod-Internet 多个级别的通信。</p>
<p>它的需求是：
* Pod 网络必须有高吞吐，高可用，低延迟，Jitter
* 用户可以在不同的粒度控制网络 Policy
* 网络操作简单，能够将 VPC routing policies，security groups 等等粘合起来。
* Pod 网络能够秒级启动。
* 至多管理 2000 台机器。</p>
<p>VPC 中的 EC2 每台机器都可以有多个 ENI，每个 ENI都可以用多个 IP 地址。主 ENI IP 地址是实例创建时自动分配的，所有的二级地址由 host owner 自己管理，在这个工具中，就是由 aws-cni 插件来完成的。</p>
<p>能创建的 IP 上线取决于你的 VPC 的 CIDR block，例如 10.0.0.0/16. 假设，每台实例有 N 个ENI，每个 ENI 可以有 M 个地址，那最多可分配的 IP 要么是子网的可用 IP 数量，要么是 N * M - N.</p>
<p>架构：
<img alt="" src="https://camo.githubusercontent.com/1ee17863f5b874bfdce2e15a198401d5525d0cd0/68747470733a2f2f73332d75732d776573742d312e616d617a6f6e6177732e636f6d2f6c6977656e2d7075626c69632f776972652d6e6574776f726b2e706e67"></p>
<ul>
<li>Pod 内部 eth0 inet 是由 ENI 分配的二级地址，例如 10.0.97.30</li>
<li>Pod 内部的路由表默认路由到 169.254.1.1， 一个写死的 IP</li>
<li>宿主机这边每块路由表里面也会有相应的 Pod IP 对应的规则</li>
<li>Pod 到 Pod 通信需要如下配置<ul>
<li>配置 veth pair：host namespace veth &amp; pod namespace veth。</li>
<li>在 pod namespace 里写入 Pod 的二级地址</li>
<li>在宿主机的路由表里加上一个 route 规则，让Pod二级地址的数据包可以路由到 veth 对应的 namespace 去。</li>
</ul>
</li>
</ul>
<p>Local IP Address Manager （L-IPAM） 是用来管理可用二级IP地址池子的工具。当 kubelet 接收到添加 Pod 的请求时，L-IPAM 会马上从池子里分配一个二级IP给 Pod。当可用 IP 低于阈值了，L-IPAM 会自动创建 ENI 分配给实例，然后当其可用时再分配二级 IP。当可用 IP 超过上限时，就销掉回收 ENI。CNI Plugin 本身是通过 gPRC 与 L-IPAM 通信的。</p>
<p>一些使用上的 Caveats：
* 遇到过 Kubernetes 无论如何也无法成功创建 Pod，Pod 一直处于 ContainerCreating 的状态。当时的原因是同时遇到了 aws-cni 自己的 bug，以及二级 IP 不够用了。
* 在 EKS 的 kube-system namespace 里面有一些叫做 aws-node 的 Pod，它们就是 aws-cni 的 daemonset 创建出来的。</p>

  </div><!-- /.entry-content -->
</section>
                </div>

                <hr>
                <div id="footer" class="col-lg-12">
                    <nav>
                        <ul>
                        </ul>
                    </nav>
                </div>
            </div>
            <div id="sidebar" class="col-lg-4">
                <h1>
                    <a href="https://www.soasme.com/techshack.weekly " title="Techshack Weekly">
                        <img src="https://www.soasme.com/techshack.weekly/images/logo-200x50.png" />
                    </a>
                </h1>
                <span class="description"> </span>
                <div><div class="entry-subscription">
    <h5>Techshack Weekly</h5>
    <br>
    专注于后端技术阅读
    <br>
    目前有上百位订阅者。
    <br>
    订阅 <a href="https://www.soasme.com/techshack.weekly/feeds/issues.atom.xml">RSS</a>
    <br>
    欢迎加入 <a href="https://t.me/techshack">Telegram Channel</a> ，
    <br>
    <iframe src="https://tgwidget.com/widget/count/?id=5a66b26483ba88e7118b4568" frameborder="0" scrolling="no" horizontalscrolling="no" verticalscrolling="no" width="160px" height="50px" async></iframe>
    <br>
    关注推特 <a href="https://twitter.com/techshackweekly">@techshackweekly</a>。
    <br>
    <a href="https://twitter.com/TechshackWeekly?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @TechshackWeekly</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <hr>
</div></div>
                <div><!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-10_7.css" rel="stylesheet" type="text/css">
<style type="text/css">
    #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif;  width:250px;}
    /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
       We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
</style>
<div id="mc_embed_signup">
<form action="https://soasme.us17.list-manage.com/subscribe/post?u=617c1cb80ba1b0cbf828df387&amp;id=10442a8ee6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    <label for="mce-EMAIL">Subscribe to our mailing list</label>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_617c1cb80ba1b0cbf828df387_10442a8ee6" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup--></div>
                    <div>:: <a href="https://www.soasme.com/techshack.weekly/categories.html">Categories</a></div>
                <!-- <span class="feed"><a href="">RSS</a> | <a href="">Atom</a></span> -->
            </div>
            <div class="col-lg-2"></div>
        </div>
    </div>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-36183732-2");
    pageTracker._trackPageview();
    } catch(err) {}</script>
</body>
</html>